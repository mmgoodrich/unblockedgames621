<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Neon Flytron</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
  <script src="TemplateData/UnityProgress.js"></script>
  <script src="Build/UnityLoader.js"></script>
  <script>
    var gameInstance = UnityLoader.instantiate("gameContainer", "Build/NeonFlytron15.json", { onProgress: UnityProgress });
    function UnityProgress(gameInstance, progress) {
      if (!gameInstance.Module)
        return;
      var r = UnityLoader.Progress.Styles[gameInstance.Module.splashScreenStyle],
        n = gameInstance.Module.progressLogoUrl ? gameInstance.Module.resolveBuildUrl(gameInstance.Module.progressLogoUrl) : r.progressLogoUrl,
        o = gameInstance.Module.progressEmptyUrl ? gameInstance.Module.resolveBuildUrl(gameInstance.Module.progressEmptyUrl) : r.progressEmptyUrl,
        i = gameInstance.Module.progressFullUrl ? gameInstance.Module.resolveBuildUrl(gameInstance.Module.progressFullUrl) : r.progressFullUrl,
        a = "position: absolute; left: 50%; top: 50%; -webkit-transform: translate(-50%, -50%); transform: translate(-50%, -50%);";
      if (!gameInstance.logo) {
        gameInstance.logo = document.createElement("div");
        gameInstance.logo.style.cssText = a + "background: url('" + n + "') no-repeat center / contain; width: 154px; height: 130px;";
        gameInstance.container.appendChild(gameInstance.logo);
      }
      if (!gameInstance.progress) {
        gameInstance.progress = document.createElement("div");
        gameInstance.progress.style.cssText = a + " height: 18px; width: 141px; margin-top: 90px;";
        gameInstance.progress.empty = document.createElement("div");
        gameInstance.progress.empty.style.cssText = "background: url('" + o + "') no-repeat right / cover; float: right; width: 100%; height: 100%; display: inline-block;";
        gameInstance.progress.appendChild(gameInstance.progress.empty);
        gameInstance.progress.full = document.createElement("div");
        gameInstance.progress.full.style.cssText = "background: url('" + i + "') no-repeat left / cover; float: left; width: 0%; height: 100%; display: inline-block;";
        gameInstance.progress.appendChild(gameInstance.progress.full);
        gameInstance.container.appendChild(gameInstance.progress);
      }
      gameInstance.progress.full.style.width = 100 * progress + "%";
      gameInstance.progress.empty.style.width = 100 * (1 - progress) + "%";
      if (progress == 1) {
        gameInstance.logo.style.display = gameInstance.progress.style.display = "none";
      }

      if (progress == 1.0) {
        if (player != null) {
          console.log("Auth True")
          gameInstance.SendMessage('UI Manager', 'AuthTrue');
          loadData();
        }
      }
    }

  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
    }

    canvas {
      position: absolute;
    }

    canvas,
    .webgl-content,
    #gameContainer {
      width: 100%;
      height: 100%;
    }
  </style>

</head>

<body>
  <div class="webgl-content">
    <div id="gameContainer"></div>
  </div>

  <script src="https://yandex.ru/games/sdk/v2"></script>

  <script type="text/javascript">

    var player = null;
    var sdk;
    var payments = null;

    function auth() {
      sdk.auth.openAuthDialog().then(() => {
        player = _player;
        gameInstance.SendMessage('UI Manager', 'AuthTrue');
        loadData();
      }).catch(() => {
      });
    }

    function initPurchasing() {
      console.log('Get Purchasing Data....');
      if (payments != null) {
        var gameShop = []
        payments.getCatalog().then(products => {
          gameShop = products;
          console.log('Get Catalog Data....');
          gameShop.forEach(product => {
            gameInstance.SendMessage('Ads Manager', 'PurchaseDataId', product.id);
            gameInstance.SendMessage('Ads Manager', 'PurchaseDataPrice', product.price);
            console.log(product.id + ' ' + product.price);
          });
        });
        payments.getPurchases().then(purchases => purchases.forEach(consumePurchase));
      }
    }

    function consumePurchase(purchase) {
      gameInstance.SendMessage('Ads Manager', 'PurchaseComplete', purchase.id);
      payments.consumePurchase(purchase.purchaseToken)
    }

    function checkAuth() {
      console.log("Check Auth")
      setTimeout(authSet(player != null), 5000)
    }

    function authSet(isAuth) {
      console.log("Auth Set " + isAuth);
      if (isAuth) {
        gameInstance.SendMessage('UI Manager', 'AuthTrue');
      }
      else {
        gameInstance.SendMessage('UI Manager', 'AuthFalse');
      }

      if (payments != null) {
        initPurchasing();
      }
    }

    function buy(id_buy) {
      if (payments != null) {
        payments.purchase({ id: id_buy }).then(purchase => {
          gameInstance.SendMessage('Ads Manager', 'PurchaseComplete', id_buy);
          if (id_buy != 'remove_ads' && id_buy != 'coins_remove_ads' && id_buy != 'get_legendary_cars' && id_buy != 'get_all_cars') {
            payments.consumePurchase(purchase.purchaseToken);
          }
        });
      }
    }

    YaGames.init({
      adv: {
        onAdvClose: wasShown => {
          console.info('adv closed!');
        }
      }
    })
      .then(ysdk => {
        sdk = ysdk;
        ysdk.getPlayer({ signed: true }).then(_player => {
          player = _player;
          console.log("You Log In");
          if (gameInstance != null) { gameInstance.SendMessage('UI Manager', 'AuthTrue'); }
        }).catch(err => {
        });
        ysdk.getPayments({ signed: true }).then(_payments => {
          payments = _payments;
          console.log("Purchasing True");
        }).catch(err => {
        })
        sdk.adv.showFullscreenAdv({ callbacks: {} });
      });

    function loadData() {
      console.log("Loading......")
      player.getData(["save"]).then(data => {
        if (data.save) {
          gameInstance.SendMessage('Save Manager', 'LoadCloud', data.save);
        }
        else {
          console.log('No Data');
        }
      }).catch(() => {
        console.log('No Data');
      });
    }
  </script>

  <script>
    function saveCloud(dataSave, counterSave) {
      console.log("Saving....... ");
      if (player != null) {
        player.getData(["save", "counter"]).then(data => {
          if (data.counter) {
            console.log('Counter ' + data.counter + " " + counterSave);
            if (data.counter < counterSave) {
              player.setData({
                save: dataSave,
                counter: counterSave,
              }).then(() => {
                console.log('data is set -update');
              });
            }
          }
          else {
            player.setData({
              save: dataSave,
              counter: counterSave,
            }).then(() => {
              console.log('data is set -first');
            });
          }
        }).catch(() => {
          player.setData({
            save: dataSave,
            counter: counterSave,
          }).then(() => {
            console.log('data is set -first');
          });
        });
      }
    }
  </script>


  <script>
    function showFullscrenAd() {
      sdk.adv.showFullscreenAdv({
        callbacks: {}
      })
    }
  </script>

  <script>
    function showRewardedAd(id) {
      sdk.adv.showRewardedVideo({
        callbacks: {
          onOpen: () => {
          },
          onRewarded: () => {
            gameInstance.SendMessage('Ads Manager', 'ReturnTime');
            gameInstance.SendMessage('Ads Manager', 'GetReward', id);
          },
          onClose: () => {
            gameInstance.SendMessage('Ads Manager', 'ReturnTime');
          },
          onError: (e) => {
            gameInstance.SendMessage('Ads Manager', 'ReturnTime');
          }
        }
      })
    }
  </script>

</body>

</html>